# Maintainer: Ink Is A Verb <codes@inkisaverb.com>
pkgname=501webapp
pkgver=1  # Must not be empty (can be anything), later replaced with the pkgver() function, getting the version from git so this does not need to be re-written on every release
pkgrel=1
pkgdesc="The VIP Code 501 CMS web app-as-package"
url="https://github.com/inkVerb/501webapp"
arch=('any')
license=('GPL')
depends=('bash' 'apache' 'php' 'mariadb' 'libxml2' 'xmlstarlet' 'imagemagick' 'ffmpeg' 'lame' 'pandoc' 'texlive-core' 'texlive-latex' 'texlive-fontsrecommended' 'texlive-latexrecommended')  # Apache becuase we use rewrites
makedepends=('git')
source=('git+https://github.com/inkVerb/501.git')
sha256sums=('SKIP')

# Dynamically set pkgver= variable based on unique source versioning
# Can go anywhere in PKGBUILD file, but usually variables are first, then functions after
pkgver() {
  cd "$pkgdir" # Same as "$srcdir/501"
    ( set -o pipefail
      git describe --long --tags --abbrev=7 2>/dev/null | sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
      git describe --long --abbrev=7 2>/dev/null | sed 's/\([^-]*-g\)/r\1/;s/-/./g' ||
      printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
  )
}

build() {
  cd "$pkgdir" # Same as "$srcdir/501"
}

package() {
  webuser=$(ps aux | grep -E '[a]pache|[h]ttpd|[_]www|[w]ww-data|[n]ginx' | grep -v root | head -1 | cut -d\  -f1)
  if [ -d "/srv/www" ]; then
    webdir="srv/www"
  elif [ -d "/var/www" ]; then
    webdir="var/www"
  else
    echo "No web folder found."
    exit 1
  fi
  cd "$pkgdir" # Same as "$srcdir/501"
  install -d "${pkgdir}/${webdir}"
  cp -r cms "${pkgdir}/${webdir}/501"

  cd "${pkgdir}/${webdir}/501"
  mv htaccess .htaccess
  mkdir -p media/docs media/audio media/video media/images media/uploads media/original/images media/original/video media/original/audio media/original/docs media/pro

  chown -R $webuser:$webuser "${pkgdir}/${webdir}/501"
}